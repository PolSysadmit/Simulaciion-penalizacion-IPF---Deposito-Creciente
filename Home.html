<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIMULACIÓN DE PENALIZACIÓN DE IPF's</title>
  <style>
    /* Añade aquí tus estilos CSS */
  </style>
</head>

<body>
  <h1>SIMULACIÓN DE PENALIZACIÓN DE IPF's</h1>
  <form id="calculadora">
    <label for="tipoTarifa">Tipo de Tarifa:</label>
    <select id="tipoTarifa" name="tipoTarifa">
      <option value="Ordinaria">Ordinaria</option>
      <option value="Coyuntural">Coyuntural</option>
    </select>
    <br>
    <label for="reintegro">Reintegro:</label>
    <select id="reintegro" name="reintegro">
      <option value="Total">Total</option>
      <option value="Parcial">Parcial</option>
    </select>
    <br>
    <label for="importe">Importe:</label>
    <input type="number" id="importe" name="importe" value="70000">
    <br>
    <label for="fechaInicio">Fecha inicio:</label>
    <input type="date" id="fechaInicio" name="fechaInicio" value="2023-03-15">
    <br>
    <label for="fechaVencimiento">Fecha vencimiento:</label>
    <input type="date" id="fechaVencimiento" name="fechaVencimiento" value="2024-03-15">
    <br>
    <label for="fechaReintegro">Fecha reintegro:</label>
    <input type="date" id="fechaReintegro" name="fechaReintegro" value="2023-09-15">
    <br>
    <div id="importeReintegroContainer">
      <label for="importeReintegro">Importe reintegro:</label>
      <input type="number" id="importeReintegro" name="importeReintegro" value="70000">
    </div>
    <label for="tipoInteres"> Tipo de interés:</label>
    <input type="number" id="tipoInteres" name="tipoInteres" value="1">
    <br>
    <label for="porcentajeRetencion"> % Retención:</label>
    <input type="number" id="porcentajeRetencion" name="porcentajeRetencion" value="20">
    <br>
    <label for="porcentajePenalizacion"> % Penalización:</label>
    <input type="number" id="porcentajePenalizacion" name="porcentajePenalizacion" value="1">
    <br>
    <button type="button" onclick="calcularLiquidacion()">Calcular</button>
  </form>
  <div id="resultados" style="display: none;">
    <h2>Resultados</h2>
    <div id="duracionMeses"></div>
    <div id="diasTranscurridos"></div>
    <div id="diasRemanentesContainer">
      <div id="diasRemanentes"></div>
    </div>
    <div id="interesesEuros"></div>
    <div id="interesesEurosReintegro"></div>
    <div id="interesesEurosDevengados"></div>
    <div id="retencionEuros"></div>
    <div id="penalizacionEuros"></div>
    <div id="maximoInteresesBrutos"></div>
    <div id="penalizacionAplicar"></div>
    <h3>
      <div id="liquidacionRealizar"></div>
    </h3>
    <div id="capital"></div>
    <div id="intereses"></div>
    <div id="retencion"></div>
    <div id="penalizacion"></div>
    <div id="total"></div>
    <br>

    <div id="Advertencia" style="display: none;"></div>
    <strong>
      <font color="red">EN TODOS LOS CASOS EL MÁXIMO A PENALIZAR SON LOS INTERESES DEVENGADOS DEL TOTAL DE LA
        IMPOSICIÓN,
        NO DEL IMPORTE REINTEGRADO.
        <br>
        <br>
        EN CASO DE HABER LIQUIDACIONES INTERMEDIAS, SE TENDRÁN EN CONSIDERACIÓN SIEMPRE LOS INTERESES NETOS YA
        LIQUIDADOS,
        COMO INTERESES DEVENGADOS.
      </font>
    </strong>
  </div>

  </div>

  <script>
    function calcularLiquidacion() {

      // Obtén los valores de los elementos de entrada
      const tipoTarifa = document.getElementById("tipoTarifa").value;
      const reintegro = document.getElementById("reintegro").value;
      const importe = parseFloat(document.getElementById("importe").value);
      const fechaInicio = new Date(document.getElementById("fechaInicio").value);
      const fechaVencimiento = new Date(document.getElementById("fechaVencimiento").value);
      const fechaReintegro = new Date(document.getElementById("fechaReintegro").value);
      const importeReintegro = (reintegro === "Parcial")
        ? parseFloat(document.getElementById("importeReintegro").value)
        : importe;
      const tipoInteres = parseFloat(document.getElementById("tipoInteres").value) / 100;
      const porcentajeRetencion = parseFloat(document.getElementById("porcentajeRetencion").value) / 100;
      const porcentajePenalizacion = parseFloat(document.getElementById("porcentajePenalizacion").value) / 100;


      const campos = {
        "importe": "El importe",
        "fechaInicio": "La fecha de inicio",
        "fechaVencimiento": "La fecha de vencimiento",
        "fechaReintegro": "La fecha de reintegro",
        "tipoInteres": "El tipo de interés",
        "porcentajeRetencion": "La retención",
        "porcentajePenalizacion": "El porcentaje de penalización"
      };

      for (let campo in campos) {
        const valor = document.getElementById(campo).value.trim();

        if (campo.includes("fecha")) {
          const fecha = new Date(valor);
          if (isNaN(fecha.getTime())) {
            alert(`El valor de '${campos[campo]}' no es una fecha válida.`);
            return;
          }
        } else if (valor === "" || isNaN(valor) || valor < 0) {
          alert(`'${campos[campo]}' es obligatorio y debe ser un valor numérico superior a 0.`);
          return;
        }
      }


      if (fechaVencimiento < fechaInicio) {
        alert("Error: La 'fecha de vencimiento' debe ser posterior a la 'fecha de inicio'.");
        return;
      }
      if (fechaReintegro < fechaInicio) {
        alert("Error: La 'fecha de reintegro' debe ser posterior a la 'fecha de inicio'.");
        return;
      }
      if (fechaReintegro < fechaInicio || fechaReintegro > fechaVencimiento) {
        alert("Error: La 'fecha de reintegro' no es válida. Debe ser mayor a la 'fecha de inicio' y menor a la 'fecha de vencimiento'.");
        return;
      }




      // Realiza los cálculos necesarios
      const duracionMeses = (fechaVencimiento - fechaInicio) / (1000 * 60 * 60 * 24 * 30.44);
      const diasTranscurridos = (fechaReintegro - fechaInicio) / (1000 * 60 * 60 * 24);
      const diasRemanentes = (fechaVencimiento - fechaReintegro) / (1000 * 60 * 60 * 24);
      const interesesEuros = importe * tipoInteres * diasTranscurridos / 365;

      //Importe * tipo intereés * días transcurridos * /365
      // Cálculo de los intereses devengados por el período transcurrido antes del reintegro
      const interesesEurosReintegro = (reintegro === 'Parcial')
        ? importeReintegro * tipoInteres * diasTranscurridos / 365
        : importe * tipoInteres * diasTranscurridos / 365;

      // Cálculo de los intereses devengados durante el período de remanencia después del reintegro
      // Si el tipo de tarifa es "Coyuntural", se resta el importe de los intereses devengados hasta el reintegro
      //=+E3*E13*E10/365
      const interesesEurosDevengados = (tipoTarifa === 'Ordinaria')
        ? importe * tipoInteres * diasRemanentes / 365
        : importe * tipoInteres * diasTranscurridos / 365

      const retencionEuros = interesesEurosReintegro * porcentajeRetencion;
      //const penalizacionEuros = importeReintegro * diasRemanentes * porcentajePenalizacion / 365;

      // Calcula la penalización en euros
      // Si el tipo de tarifa es Coyuntural y el reintegro es Total, la penalización se calcula en función de los días remanentes
      // Si no, se calcula en función de los días transcurridos
      const penalizacionEuros = (tipoTarifa === 'Ordinaria')
        ? importeReintegro * diasRemanentes * porcentajePenalizacion / 365
        : importeReintegro * diasTranscurridos * porcentajePenalizacion / 365;

      //Continuar aquí, si caso3 
      const maximoInteresesBrutos = interesesEurosDevengados;
      const penalizacionAplicar = Math.min(penalizacionEuros, maximoInteresesBrutos);

      // Liquidación a realizar
      //const capital = importe;
      const capital = (reintegro === "Parcial")
        ? importeReintegro
        : importe;

      const intereses = (reintegro === "Parcial")
        ? interesesEurosReintegro
        : interesesEuros;

      const retencion = -retencionEuros;
      //const penalizacion = (reintegro === "Total") ? -penalizacionAplicar : 0; // Cambiar "Parcial" por "Total"
      const penalizacion = -penalizacionAplicar;
      const total = capital + intereses + retencion + penalizacion;

      // Muestra los resultados en los elementos HTML correspondientes
      document.getElementById("duracionMeses").innerText = `Duración (meses): ${duracionMeses.toFixed(2)}`;
      document.getElementById("diasTranscurridos").innerText = `Días transcurridos: ${diasTranscurridos.toFixed(0)}`;
      document.getElementById("diasRemanentes").innerText = `Días remanentes: ${diasRemanentes.toFixed(0)}`;
      document.getElementById("interesesEuros").innerText = `Intereses (euros): ${interesesEuros.toFixed(2)}`;
      document.getElementById("interesesEurosReintegro").innerText = `Intereses (euros) Reintegro: ${interesesEurosReintegro.toFixed(2)}`;
      document.getElementById("interesesEurosDevengados").innerText = `Intereses (euros) Devengados: ${interesesEurosDevengados.toFixed(2)}`;
      document.getElementById("retencionEuros").innerText = `Retención (euros): ${retencionEuros.toFixed(2)}`;
      document.getElementById("penalizacionEuros").innerText = `Penalización (euros): ${penalizacionEuros.toFixed(2)}`;
      document.getElementById("maximoInteresesBrutos").innerText = `Máximo intereses brutos: ${maximoInteresesBrutos.toFixed(2)}`;
      document.getElementById("penalizacionAplicar").innerText = `Penalización a aplicar: ${penalizacionAplicar.toFixed(2)}`;
      document.getElementById("liquidacionRealizar").innerText = "Liquidación a realizar:";
      document.getElementById("capital").innerText = `+Capital: ${capital.toFixed(2)}`;
      document.getElementById("intereses").innerText = `+Intereses: ${intereses.toFixed(2)}`;
      document.getElementById("retencion").innerText = `-Retención: ${retencion.toFixed(2)}`;
      document.getElementById("penalizacion").innerText = `-Penalización: ${penalizacion.toFixed(2)}`;
      document.getElementById("total").innerText = `Total: ${total.toFixed(2)}`;
      showResults();
    }

    // Función que cambia la visibilidad del campo "Importe Reintegro" en función del valor de la opción seleccionada en "Reintegro"
    function toggleImporteReintegro() {
      const reintegro = document.getElementById("reintegro").value; // Obtiene el valor de "Reintegro"
      const importeReintegroContainer = document.getElementById("importeReintegroContainer"); // Obtiene el contenedor del campo "Importe Reintegro"

      if (reintegro === "Parcial") { // Si se seleccionó "Parcial" en "Reintegro"
        importeReintegroContainer.style.display = "block"; // Muestra el campo "Importe Reintegro"
      } else {
        importeReintegroContainer.style.display = "none"; // Oculta el campo "Importe Reintegro"
      }

      calcularLiquidacion
    }

    document.getElementById("reintegro").addEventListener("change", toggleImporteReintegro); // Añade el evento "change" a "Reintegro" que llama a la función "toggleImporteReintegro" cuando se selecciona una opción distinta
    toggleImporteReintegro(); // Establece el estado inicial en la carga de la página, para que el campo "Importe Reintegro" esté oculto si "Reintegro" tiene la opción "Total" seleccionada

    // Función que cambia la visibilidad del campo "Días remanentes" en función del valor de la opción seleccionada en "Tipo de Tarifa"
    document.getElementById("tipoTarifa").addEventListener("change", function () {

      const tipoTarifa = document.getElementById("tipoTarifa").value; // Obtiene el valor de "Tipo de Tarifa"
      const diasRemanentesContainer = document.getElementById("diasRemanentesContainer"); // Obtiene el contenedor del campo "Días remanentes"

      if (tipoTarifa === "Ordinaria") { // Si se seleccionó "Ordinaria" en "Tipo de Tarifa"
        diasRemanentesContainer.style.display = "block"; // Muestra el campo "Días remanentes"
      } else {
        diasRemanentesContainer.style.display = "none"; // Oculta el campo "Días remanentes"
      }
    });
    document.getElementById("tipoTarifa").dispatchEvent(new Event("change")); // Establece el estado inicial en la carga de la página, para que el campo "Días remanentes" esté visible si "Tipo de Tarifa" tiene la opción "Ordinaria" seleccionada

    // Crea una función para mostrar los resultados
    function showResults() {
      const resultadosDiv = document.getElementById("resultados");
      resultadosDiv.style.display = "block";
    }

    // Función que se ejecuta cuando se presiona una tecla en el formulario
    function handleKeyDown(event) {
      if (event.key === 'Enter') {
        event.preventDefault(); // Evita la acción predeterminada del evento (por ejemplo, enviar el formulario)
        calcularLiquidacion(); // Llama a la función para calcular la liquidación
      }
    }

    // Agrega el event listener al objeto document
    document.addEventListener("keydown", handleKeyDown);




  </script>




</body>

</html>